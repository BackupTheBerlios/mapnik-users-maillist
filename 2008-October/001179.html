<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mapnik-users] PostGIS plugin, estimate extents,	and mismatched coordinates
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/mapnik-users/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:mapnik-users%40lists.berlios.de?Subject=Re%3A%20%5BMapnik-users%5D%20PostGIS%20plugin%2C%20estimate%20extents%2C%0A%09and%20mismatched%20coordinates&In-Reply-To=%3CC7F5D498-C6FB-4388-837D-C93B7E52A03E%40hailmail.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001177.html">
   <LINK REL="Next"  HREF="001180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mapnik-users] PostGIS plugin, estimate extents,	and mismatched coordinates</H1>
    <B>Dane Springmeyer</B> 
    <A HREF="mailto:mapnik-users%40lists.berlios.de?Subject=Re%3A%20%5BMapnik-users%5D%20PostGIS%20plugin%2C%20estimate%20extents%2C%0A%09and%20mismatched%20coordinates&In-Reply-To=%3CC7F5D498-C6FB-4388-837D-C93B7E52A03E%40hailmail.net%3E"
       TITLE="[Mapnik-users] PostGIS plugin, estimate extents,	and mismatched coordinates">blake at hailmail.net
       </A><BR>
    <I>Wed Oct  8 23:40:59 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001177.html">[Mapnik-users] Rendering with SQL/XML
</A></li>
        <LI>Next message: <A HREF="001180.html">[Mapnik-users] PostGIS plugin, estimate extents,	and mismatched coordinates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1179">[ date ]</a>
              <a href="thread.html#1179">[ thread ]</a>
              <a href="subject.html#1179">[ subject ]</a>
              <a href="author.html#1179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I've been trying to more fully understand the various postgis plugin  
options, and I'm hoping someone can clarify the best practices and  
tradeoffs of various usages.

I'm sure I'm confusing something here, so anyone feel free to correct  
me.

It's clear that something like this (found in the OSM stylesheet)  
works fine:

       &lt;Parameter name=&quot;table&quot;&gt;(select * from planet_osm_polygon order  
by z_order,way_area desc) as leisure&lt;/Parameter&gt;
       &lt;Parameter name=&quot;estimate_extent&quot;&gt;false&lt;/Parameter&gt;
       &lt;Parameter name=&quot;extent&quot;&gt;-20037508,-19929239,20037508,19929239&lt;/ 
Parameter&gt;

where the features (in projected coordinates inside a projected layer)  
returned are sure to fall within the manually specified extent. And  
this should be fast since we are not requiring mapnik's postgis plugin  
to generate a temporary table of extents, like I see happens here:

<A HREF="http://trac.mapnik.org/browser/trunk/plugins/input/postgis/postgis.cpp#L287">http://trac.mapnik.org/browser/trunk/plugins/input/postgis/postgis.cpp#L287</A>

I've also noticed that if you use a query within the table parameter  
that radically alters the extents of the original table, one must use  
the above approach to manually set the extents otherwise the  
automatically estimated extents will not match the new extents of the  
dynamic geometries, as I noted here:

<A HREF="http://trac.mapnik.org/wiki/PostGIS#XML">http://trac.mapnik.org/wiki/PostGIS#XML</A>

But here's where I am confused: When loading OSM data in EPSG  
900913( Google Mercator) and using this configuration:

     &lt;Layer class=&quot;citylike area&quot; srs=&quot;+proj=merc +a=6378137  
+b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m  
+nadgrids=@null +no_defs +over&quot;&gt;
         &lt;Datasource&gt;
             &lt;Parameter name=&quot;type&quot;&gt;postgis&lt;/Parameter&gt;
             &lt;Parameter name=&quot;host&quot;&gt;127.0.0.1&lt;/Parameter&gt;
             &lt;Parameter name=&quot;port&quot;&gt;5432&lt;/Parameter&gt;
             &lt;Parameter name=&quot;user&quot;&gt;postgres&lt;/Parameter&gt;
             &lt;Parameter name=&quot;password&quot;&gt;&lt;/Parameter&gt;
             &lt;Parameter name=&quot;dbname&quot;&gt;gis&lt;/Parameter&gt;
             &lt;Parameter name=&quot;estimate_extent&quot;&gt;false&lt;/Parameter&gt;
             &lt;Parameter name=&quot;table&quot;&gt;(SELECT * FROM planet_osm_polygon  
WHERE landuse IN ('reservoir', 'water') OR &quot;natural&quot; IN ('lake',  
'water', 'land') ORDER BY z_order ASC) AS water&lt;/Parameter&gt;
         &lt;/Datasource&gt;
     &lt;/Layer&gt;

...without setting the extent manually, I figure that the extents  
would be calculated without the 'estimated' approach. However, while I  
assume approach on line 310 is being used here:

<A HREF="http://trac.mapnik.org/browser/trunk/plugins/input/postgis/postgis.cpp#L310">http://trac.mapnik.org/browser/trunk/plugins/input/postgis/postgis.cpp#L310</A>

in the mapnik debug output I get:

select asbinary(way) as geom,&quot;name&quot;,&quot;size&quot; from (SELECT *, (CASE WHEN  
round(way_area * 1000000) &gt;= 20 THEN 'large' WHEN round(way_area *  
1000000) &gt;= 1 THEN 'medium' ELSE 'small' END) AS size FROM  
planet_osm_polygon WHERE building IS NOT NULL ORDER BY z_order ASC,  
way_area DESC) AS citylike where way &amp;&amp;  
setSRID('BOX3D(-122.2381318249312  
0.9837931753848186,-2.175896660733377 47.67119999999999)'::box3d, 
900913);

This is obviously problematic and will not return any features because  
the BOX3D is using geographical coordinates but setting the SRID to  
900913.

I'm wondering if perhaps I have a problem with my postgis/osm  
database, or perhaps I'm just not understanding the meaning of these  
options. To test my osm setup I tried to replicate the query that  
would be created on line 310 as:

select xmin(ext),ymin(ext),xmax(ext),ymax(ext) from (select  
extent(way) as ext from planet_osm_polygon) as tmp;
    xmin    |   ymin    |   xmax    |  ymax
-----------+-----------+-----------+---------
  -13878167 | 5708620.5 | -13450855 | 6275076
(1 row)


which shows the correct output in google mercator.

So, does anyone have any idea how it is possible that in the mapnik  
debug I am getting this line?

setSRID('BOX3D(-122.2381318249312  
0.9837931753848186,-2.175896660733377 47.67119999999999)'::box3d,900913)

Thanks for any thoughts,

Dane







select xmin(ext),ymin(ext),xmax(ext),ymax(ext) from (select  
extent(way) as ext from planet_osm_line) as tmp;

  and running into cases where the datasource will return no features  
unless I'm careful.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001177.html">[Mapnik-users] Rendering with SQL/XML
</A></li>
	<LI>Next message: <A HREF="001180.html">[Mapnik-users] PostGIS plugin, estimate extents,	and mismatched coordinates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1179">[ date ]</a>
              <a href="thread.html#1179">[ thread ]</a>
              <a href="subject.html#1179">[ subject ]</a>
              <a href="author.html#1179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/mapnik-users">More information about the Mapnik-users
mailing list</a><br>
</body></html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mapnik-users] My patches for hill shading
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/mapnik-users/2009-February/index.html" >
   <LINK REL="made" HREF="mailto:mapnik-users%40lists.berlios.de?Subject=Re%3A%20%5BMapnik-users%5D%20My%20patches%20for%20hill%20shading&In-Reply-To=%3C7e70f38d0902260156y763ebeafw8a7d3325e76bcdae%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001651.html">
   <LINK REL="Next"  HREF="001653.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mapnik-users] My patches for hill shading</H1>
    <B>Artem Pavlenko</B> 
    <A HREF="mailto:mapnik-users%40lists.berlios.de?Subject=Re%3A%20%5BMapnik-users%5D%20My%20patches%20for%20hill%20shading&In-Reply-To=%3C7e70f38d0902260156y763ebeafw8a7d3325e76bcdae%40mail.gmail.com%3E"
       TITLE="[Mapnik-users] My patches for hill shading">artem at mapnik.org
       </A><BR>
    <I>Thu Feb 26 10:56:23 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001651.html">[Mapnik-users] My patches for hill shading
</A></li>
        <LI>Next message: <A HREF="001653.html">[Mapnik-users] Getting blank pngs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1652">[ date ]</a>
              <a href="thread.html#1652">[ thread ]</a>
              <a href="subject.html#1652">[ subject ]</a>
              <a href="author.html#1652">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Marcin ,

Excellent stuff! And great looking maps. I'll be in touch regarding
your patches no doubts, this is just a quick email to say thank you
very much for your contributions!

I started work on compositing (merging) using
agg:<A HREF="http://trac.mapnik.org/wiki/Compositing">http://trac.mapnik.org/wiki/Compositing</A> and I know that Brian
Quinion has done some work as well. This would be a great feature to
have in Mapnik. I'll have a look at all implementation asap.

Thanks again!
Artem

2009/2/26 Marcin Rudowski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-users">mrudowski1 at gmail.com</A>&gt;:
&gt;<i> Hi again
</I>&gt;<i>
</I>&gt;<i> After seeing hill shading in action, I did some research too in this
</I>&gt;<i> matter. I based my work on:
</I>&gt;<i> <A HREF="http://wiki.openstreetmap.org/wiki/HikingBikingMaps">http://wiki.openstreetmap.org/wiki/HikingBikingMaps</A>
</I>&gt;<i> and again came across some issues with Mapnik.
</I>&gt;<i>
</I>&gt;<i> Mapnik problems:
</I>&gt;<i> - very basic support for rasters, no opacity, no advanced merging, only
</I>&gt;<i> replacing already drawn background.
</I>&gt;<i> - no raster scaling, only nearest neighbor. I need scaling up to 64x
</I>&gt;<i> (12-18 zoom level) and mapnik generated only big squares
</I>&gt;<i> - despite my last patch, 256 color palette was still bad for slow
</I>&gt;<i> gradients like shading.
</I>&gt;<i>
</I>&gt;<i> I corrected, in some degree, all of above limits, and want
</I>&gt;<i> to share with You.
</I>&gt;<i>
</I>&gt;<i> Here are some examples of my work in action:
</I>&gt;<i> <A HREF="http://mapa.ump.waw.pl/ump-www/?zoom=11&amp;lat=49.70878&amp;lon=19.28666">http://mapa.ump.waw.pl/ump-www/?zoom=11&amp;lat=49.70878&amp;lon=19.28666</A>
</I>&gt;<i> <A HREF="http://mapa.ump.waw.pl/ump-www/?zoom=15&amp;lat=49.30126&amp;lon=19.94725">http://mapa.ump.waw.pl/ump-www/?zoom=15&amp;lat=49.30126&amp;lon=19.94725</A>
</I>&gt;<i> <A HREF="http://mapa.ump.waw.pl/ump-www/?zoom=13&amp;lat=52.56388&amp;lon=19.70792">http://mapa.ump.waw.pl/ump-www/?zoom=13&amp;lat=52.56388&amp;lon=19.70792</A>
</I>&gt;<i> <A HREF="http://mapa.ump.waw.pl/ump-www/?zoom=11&amp;lat=51.29269&amp;lon=19.3567">http://mapa.ump.waw.pl/ump-www/?zoom=11&amp;lat=51.29269&amp;lon=19.3567</A>
</I>&gt;<i> <A HREF="http://mapa.ump.waw.pl/ump-www/?zoom=11&amp;lat=54.61966&amp;lon=18.23952">http://mapa.ump.waw.pl/ump-www/?zoom=11&amp;lat=54.61966&amp;lon=18.23952</A>
</I>&gt;<i> <A HREF="http://mapa.ump.waw.pl/ump-www/?zoom=11&amp;lat=53.2975&amp;lon=18.36724">http://mapa.ump.waw.pl/ump-www/?zoom=11&amp;lat=53.2975&amp;lon=18.36724</A>
</I>&gt;<i> <A HREF="http://mapa.ump.waw.pl/ump-www/?zoom=14&amp;lat=49.39029&amp;lon=22.47346">http://mapa.ump.waw.pl/ump-www/?zoom=14&amp;lat=49.39029&amp;lon=22.47346</A>
</I>&gt;<i>
</I>&gt;<i> I use SRTM-3 v2:
</I>&gt;<i> <A HREF="ftp://e0srp01u.ecs.nasa.gov/srtm/version2/SRTM30/">ftp://e0srp01u.ecs.nasa.gov/srtm/version2/SRTM30/</A>
</I>&gt;<i> converted to mercator projection (gdal) avoiding elipsoid-&gt;spheroid
</I>&gt;<i> reprojection (only latlon-&gt;mercator) with pixel size: 76.437 x 76.437 m.
</I>&gt;<i> Based on srtm-3 resolution, it should be 90x90, but alignment to output
</I>&gt;<i> resolution was needed. 76.437 is closest number to 90 from
</I>&gt;<i> (2*pi*6378137)/2^n set.
</I>&gt;<i> For Poland, this gives 16000x14000 GeoTIFF in resolution aligned
</I>&gt;<i> to zoom 11. I made scaled copies 50% and 25% for lower zooms, to
</I>&gt;<i> increase speed and avoid downscaling. I could do the same to avoid
</I>&gt;<i> upscaling, but already it is 250MB file, and each zoom would make it 4x
</I>&gt;<i> bigger then previous.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Patches are in attachment (hopefully this time :) ), here I will
</I>&gt;<i> describe in short, what is changed, and what can be done more.
</I>&gt;<i>
</I>&gt;<i> 1) Raster opacity
</I>&gt;<i>
</I>&gt;<i> Added opacity handling using existing methods. It isn't needed
</I>&gt;<i> for shading, but can be useful. To enable opacity, add css style opacity
</I>&gt;<i> to RasterSymbolizer. It works both for cairo and internal agg renderer.
</I>&gt;<i>
</I>&gt;<i> 2) Raster merging
</I>&gt;<i>
</I>&gt;<i> Added some basic merging methods. I use for hill shading which is gimp
</I>&gt;<i> like &quot;merge grain&quot;:
</I>&gt;<i> <A HREF="http://docs.gimp.org/en/gimp-concepts-layer-modes.html#id2834930">http://docs.gimp.org/en/gimp-concepts-layer-modes.html#id2834930</A>
</I>&gt;<i> Default is normal mode, to select differently, set css &quot;mode&quot; to
</I>&gt;<i> desired value. Available modes based on given link:
</I>&gt;<i> - grain_merge : bg + fg - 0.5
</I>&gt;<i> - grain_merge2 : bg + fg*2 - 1.0
</I>&gt;<i> - multiply : fg * bg
</I>&gt;<i> - multiply2 : fg * bg * 2.0
</I>&gt;<i> - divide : bg / fg
</I>&gt;<i> - divide2 : bg * 2.0 / fg
</I>&gt;<i> - screen : 1 - (1-fg)(1-g)
</I>&gt;<i> - hard_light : ..... (look ad link above)
</I>&gt;<i>
</I>&gt;<i> Agg renderer have some similar code in
</I>&gt;<i> agg/include/agg_pixfmt_rgba.h
</I>&gt;<i> but I didn't use it. I wrote my code based on existing part for alpha
</I>&gt;<i> blending from mapnik/include/mapnik/graphics.hpp.
</I>&gt;<i> This fix works only with agg renderer, I couldn't find appropriate way
</I>&gt;<i> to implement it using Cairo. I googled and found some references to
</I>&gt;<i> filters for ie. hard light, but no documentation or examples, and I'm
</I>&gt;<i> not sure if it exists in cairo.
</I>&gt;<i> This fix and previous probably handle:
</I>&gt;<i> <A HREF="http://trac.mapnik.org/ticket/157">http://trac.mapnik.org/ticket/157</A>
</I>&gt;<i> if someone could implement it also in cairo, or at least show me right
</I>&gt;<i> direction.
</I>&gt;<i>
</I>&gt;<i> 3) Raster scaling
</I>&gt;<i>
</I>&gt;<i> Added bilinear scaling algorithm. Algorithm can be selected with css
</I>&gt;<i> &quot;scaling&quot; parameter and available values are:
</I>&gt;<i> - fast : nearest neighbor as it was already
</I>&gt;<i> - bilinear : new bilinear interpolation for all 4 chanels (RGBA)
</I>&gt;<i> - bilinear8 : as bilinear, but only one channel assumed. This probably
</I>&gt;<i> needs some fix, as it doesn't handle alfa. I added it to speedup in my
</I>&gt;<i> case, where raster is grayscale without transparency.
</I>&gt;<i>
</I>&gt;<i> Scaling in cairo renderer could be reimplemented using matrix, but I use
</I>&gt;<i> mapnik-0.5.1 with my patches, so basically I concentrated on
</I>&gt;<i> agg renderer.
</I>&gt;<i>
</I>&gt;<i> 4) 256 color palette optimizations
</I>&gt;<i>
</I>&gt;<i> My previous patch removed obvious bug in octree. Still, generated
</I>&gt;<i> palette is not enough for hill shading. It looks more like 50 colors,
</I>&gt;<i> then 256. The problem is with prunning only on lowest level, so all left
</I>&gt;<i> leafs are almost on the same level. It is similar to dividing to even
</I>&gt;<i> ranges, regardless of density. My patch prunes only branches with lowest
</I>&gt;<i> pixel count from all levels, so subtrees with many leafs, remain deeper,
</I>&gt;<i> then one with smaller sample count.
</I>&gt;<i>
</I>&gt;<i> Some limiting was needed, to allow colors with small sample count to
</I>&gt;<i> remain unharmed (ie, some distinctive feature on map with not enough
</I>&gt;<i> pixels, to &quot;fight&quot; with gradients should be preserved).
</I>&gt;<i> I didn't find any significant increase in processing time, and
</I>&gt;<i> only 5-10% increase in size (due to more significant colors). Effects
</I>&gt;<i> are almost as good, as optimal palette without error-diffusion in
</I>&gt;<i> imagemagick or Gimp.
</I>&gt;<i>
</I>&gt;<i> Still there are problem with color assignment, because quite often cube
</I>&gt;<i> for classified color doesn't have the best color. Neighbor cubes should
</I>&gt;<i> be compared, but traversing octree is fast, but not free. I made some
</I>&gt;<i> fix, to check siblings and neighbour cubes (going up and down the
</I>&gt;<i> three), but it increased processing time of quantization about 40% and
</I>&gt;<i> effects aren't so much worse without it. It isn't included in
</I>&gt;<i> attachment.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Example osm.xml fragment:
</I>&gt;<i> &lt;Style name=&quot;raster18&quot;&gt;
</I>&gt;<i> &#160; &#160;&lt;Rule&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160;&lt;MaxScaleDenominator&gt;1000000&lt;/MaxScaleDenominator&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160;&lt;MinScaleDenominator&gt;250000&lt;/MinScaleDenominator&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160;&lt;RasterSymbolizer&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;&lt;CssParameter name=&quot;opacity&quot;&gt;1.0&lt;/CssParameter&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;&lt;CssParameter name=&quot;scaling&quot;&gt;bilinear&lt;/CssParameter&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;&lt;CssParameter name=&quot;mode&quot;&gt;grain_merge&lt;/CssParameter&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160;&lt;/RasterSymbolizer&gt;
</I>&gt;<i> &#160; &#160;&lt;/Rule&gt;
</I>&gt;<i> &lt;/Style&gt;
</I>&gt;<i> &lt;Layer name=&quot;dem18&quot; status=&quot;on&quot; &gt;
</I>&gt;<i> &#160; &#160;&lt;StyleName&gt;raster18&lt;/StyleName&gt;
</I>&gt;<i> &#160; &#160;&lt;Datasource&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160;&lt;Parameter name=&quot;type&quot;&gt;gdal&lt;/Parameter&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160;&lt;Parameter name=&quot;file&quot;&gt;&geotiffs;/hill_15m.tif&lt;/Parameter&gt;
</I>&gt;<i> &#160; &#160; &#160; &#160;&lt;Parameter name=&quot;format&quot;&gt;tiff&lt;/Parameter&gt;
</I>&gt;<i> &#160; &#160;&lt;/Datasource&gt;
</I>&gt;<i> &lt;/Layer&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Attachments:
</I>&gt;<i>
</I>&gt;<i> - mapnik.mr.palette2.patch.gz : palette fix 4)
</I>&gt;<i> - mapnik.mr.scale.patch.gz : scaling methods
</I>&gt;<i> - mapnik.mr.raster1.patch.gz : parsing RasterSymbolizer rule
</I>&gt;<i> - mapnik.mr.process.patch.gz : using raster params to select scaling
</I>&gt;<i> algorithm, opacity and merging method.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Additional notes:
</I>&gt;<i>
</I>&gt;<i> If scaling and tiling, there can be some problems with alignment if
</I>&gt;<i> raster resolution isn't integer multiply of output resolution and
</I>&gt;<i> rendered regions have margin, like in mod_tile:
</I>&gt;<i> A---------B---|---A-----------B
</I>&gt;<i> Because size and position of source raster bbox is averaged to pixel steps,
</I>&gt;<i> error can be different on each edge and '|' in A image could be
</I>&gt;<i> displaced in B image. 0.5 pix in raster could mean 16px after 32x scaling (5
</I>&gt;<i> zoom steps) and this is noticeable even earlier.
</I>&gt;<i>
</I>&gt;<i> I use raster in resolution of zoom 11, so scaling is power of 2 and any
</I>&gt;<i> errors are same on each rendered edge. In my case, mod_tile renders
</I>&gt;<i> in each zoom: &#160;9*256 x 9*256 region. This is cut with 128 margin to 8x8
</I>&gt;<i> tiles, each 256x256 size. Everything is scaled by power of 2, and
</I>&gt;<i> everything is aligned.
</I>&gt;<i>
</I>&gt;<i> It shouldn't(?) matter if we consider no margin tile joining:
</I>&gt;<i> A--------AB---------B.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Adding hill shading to my Mapnik using raster increased generation time
</I>&gt;<i> only about 2x (35tiles/s -&gt; 17 tiles/s).
</I>&gt;<i>
</I>&gt;<i> In my case map is updated ~twice a week and only 300k are forced to
</I>&gt;<i> redraw and send to cache server.
</I>&gt;<i>
</I>&gt;<i> I use self-patched mapnik 0.5.1 with some 3 months old version
</I>&gt;<i> of mod_tile for apache. Actually I have two mod_tile modules, to handle
</I>&gt;<i> two separate osm.xml and two databases, which I switch on update.
</I>&gt;<i>
</I>&gt;<i> My osm.xml is divided to separate files defining layers, styles, db
</I>&gt;<i> settings etc. Styles are grouped by categories. In effect I have 22 xml
</I>&gt;<i> files that sum up to 420kB. Thank You for libxml2 features, or I would
</I>&gt;<i> go insane managing this in one osm.xml :)
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Marcin Rudowski
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mapnik-users mailing list
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-users">Mapnik-users at lists.berlios.de</A>
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-users">https://lists.berlios.de/mailman/listinfo/mapnik-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001651.html">[Mapnik-users] My patches for hill shading
</A></li>
	<LI>Next message: <A HREF="001653.html">[Mapnik-users] Getting blank pngs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1652">[ date ]</a>
              <a href="thread.html#1652">[ thread ]</a>
              <a href="subject.html#1652">[ subject ]</a>
              <a href="author.html#1652">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/mapnik-users">More information about the Mapnik-users
mailing list</a><br>
</body></html>
